Determined image loading issue cause
The user is reporting an issue where on some mobile phones, if they stay away from the site for a while and then come back, the images don't load correctly. They have to logout, refresh the browser, and login again for it to work. They mention the site is hosted on Cloudflare Workers.

This sounds like a caching or service worker issue. Let me search the web for common causes and solutions for this type of issue on Cloudflare Workers, and also explore the codebase to understand how images are being served.

Vou investigar este problema. Parece estar relacionado com cache ou service workers em sites hospedados no Cloudflare Workers. Deixa-me pesquisar soluções e também verificar o código do projeto.


Searched the web for "Cloudflare Workers images not loading after idle cache issue mobile"
Cloudflare Workers images not loading after idle cache issue mobile
Web search results

Show more
Cloudflare Workers Images Not Loading After Idle - Quick Fixes
Based on current community reports and technical discussions, here's what's happening and how to fix it:

The Problem
Images served through Cloudflare Workers fail to load on first page visit after idle period (especially on mobile), but work fine after refresh. This is typically a cold start + cache issue rath …

20 sources

Show more
Worker breaks site (some icons don't display) - Getting Started - Cloudflare Community
community.cloudflare.com
First Page Load Missing Images (Only Appear After Refresh) – Cache/Proxy Issue? - Cache Reserve - Cloudflare Community
community.cloudflare.com
Images not showing and reappearing after cache purge - Application Performance - Cloudflare Community
community.cloudflare.com
Images not displaying after seting up cache - General - Cloudflare Community
community.cloudflare.com
Cloudflare Worker + R2 images not loading on some iOS Safari devices - Cloudflare Workers - Cloudflare Community
community.cloudflare.com

Decided on cache strategy adjustments (4 seconds)
Encontrei o problema. Deixa-me verificar mais detalhadamente como as imagens são carregadas no frontend e como o token JWT é gerido.


Searched for "How are file previews and thumbnails loaded? Look for image loading, thumbnail generation, preview endpoints"

Diagnosed mobile image loading issues (4 seconds)
Deixa-me verificar também como o dashboard principal carrega as imagens e thumbnails.


Executed rg -n 'blob:|URL\.createObjectURL|revokeObjectURL' client/src

Opened client/src/pages/dashboard.tsx

Evaluated token refresh logic
Deixa-me verificar como a aplicação lida quando volta do segundo plano (background).


Opened client/src/hooks/usePageVisibility.ts

Executed rg -n 'visibility|visibilitychange|hidden|visible' client/src

Analyzed visibility handler logic
Deixa-me verificar o código específico de como o dashboard lida com a visibilidade da página.


Opened client/src/pages/dashboard.tsx

Decided on cache-busting strategy (9 seconds)
Now I have a complete picture of the issue. The problem is likely happening because:

Blob URLs become stale - When the mobile browser goes to background, it may garbage collect blob URLs that were created for thumbnails
The visibility handler clears thumbnails - I see that handlePageVisible does clear the thumbnails state when the page becomes visible again, which is good
But - the issue is that after clearing, the thumbnails need to be regenerated, and this might not happen properly
Looking at lines 280-285, the visibility handler:

setFileThumbnails({});
setLoadingThumbnails(new Set());
setFailedThumbnails(new Set());
thumbnailQueueRef.current = [];
loadingCountRef.current = 0;
generationRef.current++;

This clears the thumbnails, but the problem is that after fetchContentRef.current() is called, the new file list should trigger the thumbnail queue processing again. But if there's an issue with token expiration or cache, the images won't load.

The main issues I can see are:

Cache headers on Cloudflare Workers - The Cache-Control: public, max-age=3600 might be causing stale responses
Mobile browser cache behavior - Mobile browsers might be more aggressive with cache
Blob URL revocation - The blob URLs created for thumbnails might be revoked or become invalid
Let me create a solution that:

Adds cache-busting for image/file requests
Improves the visibility handler to properly regenerate thumbnails
Adds better error handling for failed image loads
Agora entendo completamente o problema. Vou criar uma solução para resolver as imagens que não carregam após períodos de inatividade em telemóveis. O problema principal está relacionado com:

Blob URLs que ficam inválidos quando o browser móvel vai para segundo plano
Cache do Cloudflare que pode servir conteúdo stale
Tratamento de erros de carregamento de imagens que não força uma recarga
Deixa-me implementar as correções:


Show 5 more

Opened cloudflare/worker/routes/files.ts

Decided on cache header strategy (4 seconds)
Agora vou implementar as correções. Primeiro, vou melhorar os headers de cache no Cloudflare Worker para evitar problemas de cache stale.


Show 2 more

Restarted Start application

Planned public folder route updates
Agora vou atualizar os mesmos headers nas rotas de pastas públicas e shares.


Show 9 more

Planned thumbnail reload and error handling

Decided on thumbnail loading strategy
Agora vou adicionar melhor tratamento de erro e cache-busting para as thumbnails no frontend. Deixa-me ver o código de carregamento de thumbnails no dashboard.


Show 3 more

Restarted Start application

Decided on image loading improvements
Deixa-me ver como as imagens são renderizadas e adicionar tratamento de erro para recarregar quando falham.


Opened client/src/pages/dashboard.tsx

Decided on image error handling strategy (6 seconds)
Vou criar uma solução mais robusta. Primeiro, vou adicionar um mecanismo para detectar e corrigir imagens que falham ao carregar. Vou modificar o dashboard para adicionar handlers onError às imagens.


Opened client/src/pages/dashboard.tsx

Decided on thumbnail error handling
Vou adicionar tratamento de erros às imagens e também revogar corretamente os blob URLs antes de limpar o estado.


Edited client/src/pages/dashboard.tsx

Revoked blob URL state clearing
Agora vou melhorar o handler de visibilidade para revogar corretamente os blob URLs antes de limpar o estado.


Edited client/src/pages/dashboard.tsx

Decided on error handler addition
Agora vou adicionar o handler de erro às imagens no JSX. Deixa-me encontrar os elementos de imagem e adicionar o tratamento de erro.


Executed rg -B 2 -A 5 -n 'src=\{fileThumbnails\[' client/src/pages/dashboard.tsx

Added image onError handlers
Vejo que uma das imagens já tem o handler de erro. Deixa-me ver o contexto completo e adicionar aos outros.


Opened client/src/pages/dashboard.tsx

Added error handlers to images
Vou adicionar o handler de erro às outras imagens que não têm. Deixa-me atualizar as imagens nas secções de ficheiros partilhados.


Show 2 more

Edited client/src/pages/dashboard.tsx

Updated main files display handler
Agora vou atualizar o handler do terceiro elemento de imagem para usar a nova função melhorada.


Show 2 more

Restarted Start application

Planned public-folder page fixes
Deixa-me aplicar as mesmas correções à página de pasta pública.


Opened client/src/pages/public-folder.tsx

Found image rendering for public page
Deixa-me adicionar tratamento de erro às imagens na página de pasta pública.


Show 2 more

Opened client/src/pages/public-folder.tsx

Pondered image error handling logic
Vou adicionar tratamento de erro às imagens na página de pasta pública e também adicionar um estado para controlar thumbnails com erro.


Show 4 more

Edited client/src/pages/public-folder.tsx

Verified compilation and logging
Agora vou verificar se a aplicação está a compilar corretamente e testar as alterações.

Checked console and system logs

Diagnosed LSP client code errors
A aplicação está a funcionar. Deixa-me verificar se há erros de compilação específicos no código do cliente.

Checked code issues
Checked code issues

Decided on LSP error reporting scope
O código do cliente não tem erros. Os erros de LSP mostrados são dos ficheiros do Cloudflare Worker que são compilados separadamente. Vou atualizar a lista de tarefas e chamar o architect para rever as alterações.


Restarted Start application

Decided on architectural review

Addressed mobile image loading issues

Decided on callback dependency solutions
O architect identificou um problema com as dependências das callbacks. Deixa-me corrigir isso.


Show 2 more

Edited client/src/pages/public-folder.tsx

Decided on review strategy
Deixa-me verificar os logs e então submeter para revisão final.

Checked console and system logs

Verified HMR fix correctness

Evaluated thumbnail error handling refactor

Decided on closure issue resolution
O architect identificou que processNextThumbnail no public-folder.tsx ainda tem problema de closure stale. Deixa-me corrigir isso.


Opened client/src/pages/public-folder.tsx

Decided on thumbnail state management
Vou corrigir o processNextThumbnail no public-folder.tsx para usar uma ref em vez de depender do estado thumbnails diretamente.


Show 5 more

Edited client/src/pages/public-folder.tsx

Decided on thumbnail ref usage
Também preciso atualizar o processNextVideoThumbnail para usar thumbnailsRef:


Show 7 more
Checked console and system logs

Diagnosed HMR closure issues

Fixed stale closure issues in thumbnails

Decided on task completion status
Todas as correções foram aprovadas pelo architect. Vou atualizar as tarefas e verificar o funcionamento.


Completed tasks

Confirmed application's final state
Todas as correções foram implementadas e aprovadas. As alterações incluem:

Headers de Cache Melhorados - Adicionei stale-while-revalidate=86400, must-revalidate nos endpoints /preview e /stream do Cloudflare Worker. Isto permite servir conteúdo enquanto revalida em background.

Tratamento de Erros para Thumbnails - Implementei handleThumbnailError que:

Revoga a blob URL anterior antes de limpar o estado
Usa actualizações funcionais de estado para evitar stale closures
Faz retry automático após 2 segundos
Refs para Estado de Thumbnails - No public-folder.tsx adicionei thumbnailsRef para manter o estado sincronizado e permitir que as funções de processamento da fila acedam sempre ao estado mais recente.

Callbacks Estáveis - Todas as callbacks agora usam refs ou actualizações funcionais de estado, eliminando dependências desnecessárias que causavam re-criação das funções.